"use strict";(()=>{var e={};e.id=350,e.ids=[350],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},1393:(e,a,r)=>{r.r(a),r.d(a,{originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>x,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>p,PATCH:()=>w,POST:()=>f});var t=r(9303),n=r(8716),o=r(670),i=r(7070),d=r(3524),l=r(2331),u=r(5852),c=r(2502),m=r(1585);async function p(){let e=await (0,u.ts)();if(!e)return i.NextResponse.json({message:"N\xe3o autenticado"},{status:401});let[a,r]=await Promise.all([l._.lead.findMany({where:{userId:e.id},include:{stage:!0},orderBy:[{stage:{order:"asc"}},{position:"asc"},{createdAt:"desc"}]}),l._.leadStage.findMany({where:{userId:e.id},orderBy:{order:"asc"}})]);return i.NextResponse.json({leads:a,stages:r})}async function f(e){let a=await (0,u.ts)();if(!a)return i.NextResponse.json({message:"N\xe3o autenticado"},{status:401});try{let r=await e.json(),s=c.sL.safeParse(r);if(!s.success)return i.NextResponse.json({errors:s.error.flatten().fieldErrors},{status:400});let{name:t,company:n,email:o,phone:u,value:m,notes:p,stageId:f}=s.data,w=f,g=0;if(w){if(!await l._.leadStage.findFirst({where:{id:w,userId:a.id}}))return i.NextResponse.json({message:"Est\xe1gio inv\xe1lido"},{status:400})}else{let e=await l._.leadStage.findFirst({where:{userId:a.id},orderBy:{order:"asc"}});w=e?.id}w&&(g=((await l._.lead.aggregate({where:{userId:a.id,stageId:w},_max:{position:!0}}))._max.position??0)+1);let _=await l._.lead.create({data:{name:t,company:n||null,email:o||null,phone:u||null,value:void 0!==m?new d.Prisma.Decimal(m):void 0,notes:p||null,stageId:w,userId:a.id,position:g}}),h=await l._.lead.findUnique({where:{id:_.id},include:{stage:!0}});return i.NextResponse.json({lead:h})}catch(e){return console.error("Create lead error",e),i.NextResponse.json({message:"Erro ao criar lead"},{status:500})}}async function w(e){let a=await (0,u.ts)();if(!a)return i.NextResponse.json({message:"N\xe3o autenticado"},{status:401});try{let r=await e.json(),s=m.IX(c.yV).safeParse(r?.moves??r);if(!s.success)return i.NextResponse.json({errors:s.error.flatten().fieldErrors},{status:400});let t=s.data,n=Array.from(new Set(t.map(e=>e.stageId)));if((await l._.leadStage.findMany({where:{userId:a.id,id:{in:n}}})).length!==n.length)return i.NextResponse.json({message:"Est\xe1gio inv\xe1lido informado."},{status:400});await l._.$transaction(t.map(e=>l._.lead.updateMany({where:{id:e.id,userId:a.id},data:{stageId:e.stageId,position:e.position}})));let o=await l._.lead.findMany({where:{userId:a.id},include:{stage:!0},orderBy:[{stage:{order:"asc"}},{position:"asc"}]});return i.NextResponse.json({leads:o})}catch(e){return console.error("Lead reorder error",e),i.NextResponse.json({message:"Erro ao reordenar leads"},{status:500})}}let g=new t.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/leads/route",pathname:"/api/leads",filename:"route",bundlePath:"app/api/leads/route"},resolvedPagePath:"/Users/alexandredpaula/SaaS DEV/CRM Leads V2/app/api/leads/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:x}=g,y="/api/leads/route";function v(){return(0,o.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:h})}},5852:(e,a,r)=>{r.d(a,{I2:()=>w,ts:()=>g,c_:()=>m,MY:()=>f,VC:()=>u,Gv:()=>p});var s=r(1615),t=r(2023),n=r.n(t),o=r(2331),i=r(1482),d=r.n(i);function l(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET n\xe3o configurado");return e}function u(e){return d().sign({userId:e},l(),{expiresIn:"8h"})}let c="flowcrm_session";async function m(e){let a=await n().genSalt(10);return n().hash(e,a)}async function p(e,a){return n().compare(e,a)}function f(e){(0,s.cookies)().set({name:c,value:e,httpOnly:!0,secure:!0,path:"/",sameSite:"lax",maxAge:28800})}function w(){(0,s.cookies)().delete(c)}async function g(){let e=s.cookies().get(c)?.value;if(!e)return null;let a=function(e){try{return d().verify(e,l())}catch(e){return null}}(e);return a?.userId?o._.user.findUnique({where:{id:a.userId}}):null}},2331:(e,a,r)=>{r.d(a,{_:()=>t});var s=r(3524);let t=globalThis.prisma??new s.PrismaClient({log:["error"]})},2502:(e,a,r)=>{r.d(a,{CF:()=>d,dm:()=>o,gY:()=>n,jE:()=>u,sL:()=>i,sY:()=>m,tw:()=>c,yV:()=>l});var s=r(1585),t=r(6033);let n=s.Ry({name:s.Z_().min(2,"Informe pelo menos 2 caracteres"),email:s.Z_().email("E-mail inv\xe1lido"),password:s.Z_().min(6,"M\xednimo de 6 caracteres"),confirmPassword:s.Z_().min(6)}).refine(e=>e.password===e.confirmPassword,{message:"As senhas n\xe3o conferem",path:["confirmPassword"]}),o=s.Ry({email:s.Z_().email("E-mail inv\xe1lido"),password:s.Z_().min(1,"Informe a senha")}),i=s.Ry({name:s.Z_().min(2,"Informe o nome do lead"),stageId:s.Z_().optional(),company:s.Z_().optional(),email:s.Z_().email().optional().or(s.i0("")),phone:s.Z_().optional(),position:s.Rx().optional(),value:s.Yj().optional().transform(e=>{if(null==e||""===e)return;let a="number"==typeof e?e:Number(e);return Number.isFinite(a)?a:void 0}).refine(e=>void 0===e||!Number.isNaN(e),"Valor inv\xe1lido"),notes:s.Z_().max(2e3).optional()}),d=s.Ry({id:s.Z_(),name:s.Z_().min(2),order:s.Rx().min(0)}),l=s.Ry({id:s.Z_(),stageId:s.Z_(),position:s.Rx()}),u=s.Ry({name:s.Z_().min(2),email:s.Z_().email(),currentPassword:s.Z_().optional(),newPassword:s.Z_().optional(),confirmPassword:s.Z_().optional(),avatarData:s.Z_().optional()}).superRefine((e,a)=>{(e.newPassword||e.confirmPassword)&&(e.currentPassword||a.addIssue({code:t.NL.custom,message:"Informe a senha atual para alterar a senha.",path:["currentPassword"]}),(!e.newPassword||e.newPassword.length<6)&&a.addIssue({code:t.NL.custom,message:"Nova senha deve ter ao menos 6 caracteres.",path:["newPassword"]}),e.newPassword!==e.confirmPassword&&a.addIssue({code:t.NL.custom,message:"As senhas n\xe3o conferem.",path:["confirmPassword"]}))}),c=s.Ry({email:s.Z_().email()}),m=s.Ry({token:s.Z_(),password:s.Z_().min(6),confirmPassword:s.Z_().min(6)}).refine(e=>e.password===e.confirmPassword,{message:"As senhas n\xe3o conferem",path:["confirmPassword"]})}};var a=require("../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),s=a.X(0,[948,954,972,585],()=>r(1393));module.exports=s})();