"use strict";(()=>{var e={};e.id=442,e.ids=[442],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},5066:(e,a,r)=>{r.r(a),r.d(a,{originalPathname:()=>_,patchFetch:()=>P,requestAsyncStorage:()=>g,routeModule:()=>x,serverHooks:()=>v,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>f,PUT:()=>w});var t=r(9303),n=r(8716),o=r(670),i=r(7070),l=r(2331),u=r(5852),m=r(2502),p=r(7147),d=r(1017),c=r.n(d);async function f(){let e=await (0,u.ts)();return e?i.NextResponse.json({user:{id:e.id,name:e.name,email:e.email,avatarUrl:e.avatarUrl}}):i.NextResponse.json({message:"N\xe3o autenticado"},{status:401})}async function w(e){let a=await (0,u.ts)();if(!a)return i.NextResponse.json({message:"N\xe3o autenticado"},{status:401});try{let r;let s=await e.json(),t=m.jE.safeParse(s);if(!t.success)return i.NextResponse.json({errors:t.error.flatten().fieldErrors},{status:400});let{name:n,email:o,currentPassword:d,newPassword:f,avatarData:w}=t.data;if(o!==a.email){let e=await l._.user.findUnique({where:{email:o}});if(e&&e.id!==a.id)return i.NextResponse.json({message:"E-mail j\xe1 est\xe1 em uso."},{status:400})}if(f){if(!await (0,u.Gv)(d??"",a.passwordHash))return i.NextResponse.json({message:"Senha atual inv\xe1lida."},{status:400});r=await (0,u.c_)(f)}let x=a.avatarUrl;if(w){let e=w.match(/^data:(image\/(?:png|jpeg|jpg));base64,(.+)$/);if(!e)return i.NextResponse.json({message:"Formato de avatar inv\xe1lido."},{status:400});let[,r,s]=e,t=Buffer.from(s,"base64"),n=c().join(process.cwd(),"public","avatars");await p.promises.mkdir(n,{recursive:!0});let o=`${a.id}.${"image/png"===r?"png":"jpg"}`;await p.promises.writeFile(c().join(n,o),t),x=`/avatars/${o}`}let g=await l._.user.update({where:{id:a.id},data:{name:n,email:o,avatarUrl:x,...r?{passwordHash:r}:{}}});return i.NextResponse.json({user:{id:g.id,name:g.name,email:g.email,avatarUrl:g.avatarUrl}})}catch(e){return console.error("Profile update error",e),i.NextResponse.json({message:"Erro ao atualizar perfil"},{status:500})}}let x=new t.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/profile/route",pathname:"/api/profile",filename:"route",bundlePath:"app/api/profile/route"},resolvedPagePath:"/Users/alexandredpaula/SaaS DEV/CRM Leads V2/app/api/profile/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:v}=x,_="/api/profile/route";function P(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:h})}},5852:(e,a,r)=>{r.d(a,{I2:()=>w,ts:()=>x,c_:()=>d,MY:()=>f,VC:()=>m,Gv:()=>c});var s=r(1615),t=r(2023),n=r.n(t),o=r(2331),i=r(1482),l=r.n(i);function u(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET n\xe3o configurado");return e}function m(e){return l().sign({userId:e},u(),{expiresIn:"8h"})}let p="flowcrm_session";async function d(e){let a=await n().genSalt(10);return n().hash(e,a)}async function c(e,a){return n().compare(e,a)}function f(e){(0,s.cookies)().set({name:p,value:e,httpOnly:!0,secure:!0,path:"/",sameSite:"lax",maxAge:28800})}function w(){(0,s.cookies)().delete(p)}async function x(){let e=s.cookies().get(p)?.value;if(!e)return null;let a=function(e){try{return l().verify(e,u())}catch(e){return null}}(e);return a?.userId?o._.user.findUnique({where:{id:a.userId}}):null}},2331:(e,a,r)=>{r.d(a,{_:()=>t});var s=r(3524);let t=globalThis.prisma??new s.PrismaClient({log:["error"]})},2502:(e,a,r)=>{r.d(a,{CF:()=>l,dm:()=>o,gY:()=>n,jE:()=>m,sL:()=>i,sY:()=>d,tw:()=>p,yV:()=>u});var s=r(1585),t=r(6033);let n=s.Ry({name:s.Z_().min(2,"Informe pelo menos 2 caracteres"),email:s.Z_().email("E-mail inv\xe1lido"),password:s.Z_().min(6,"M\xednimo de 6 caracteres"),confirmPassword:s.Z_().min(6)}).refine(e=>e.password===e.confirmPassword,{message:"As senhas n\xe3o conferem",path:["confirmPassword"]}),o=s.Ry({email:s.Z_().email("E-mail inv\xe1lido"),password:s.Z_().min(1,"Informe a senha")}),i=s.Ry({name:s.Z_().min(2,"Informe o nome do lead"),stageId:s.Z_().optional(),company:s.Z_().optional(),email:s.Z_().email().optional().or(s.i0("")),phone:s.Z_().optional(),position:s.Rx().optional(),value:s.Yj().optional().transform(e=>{if(null==e||""===e)return;let a="number"==typeof e?e:Number(e);return Number.isFinite(a)?a:void 0}).refine(e=>void 0===e||!Number.isNaN(e),"Valor inv\xe1lido"),notes:s.Z_().max(2e3).optional()}),l=s.Ry({id:s.Z_(),name:s.Z_().min(2),order:s.Rx().min(0)}),u=s.Ry({id:s.Z_(),stageId:s.Z_(),position:s.Rx()}),m=s.Ry({name:s.Z_().min(2),email:s.Z_().email(),currentPassword:s.Z_().optional(),newPassword:s.Z_().optional(),confirmPassword:s.Z_().optional(),avatarData:s.Z_().optional()}).superRefine((e,a)=>{(e.newPassword||e.confirmPassword)&&(e.currentPassword||a.addIssue({code:t.NL.custom,message:"Informe a senha atual para alterar a senha.",path:["currentPassword"]}),(!e.newPassword||e.newPassword.length<6)&&a.addIssue({code:t.NL.custom,message:"Nova senha deve ter ao menos 6 caracteres.",path:["newPassword"]}),e.newPassword!==e.confirmPassword&&a.addIssue({code:t.NL.custom,message:"As senhas n\xe3o conferem.",path:["confirmPassword"]}))}),p=s.Ry({email:s.Z_().email()}),d=s.Ry({token:s.Z_(),password:s.Z_().min(6),confirmPassword:s.Z_().min(6)}).refine(e=>e.password===e.confirmPassword,{message:"As senhas n\xe3o conferem",path:["confirmPassword"]})}};var a=require("../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),s=a.X(0,[948,954,972,585],()=>r(5066));module.exports=s})();